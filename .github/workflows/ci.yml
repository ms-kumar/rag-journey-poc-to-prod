name: ci
on: [push, pull_request]

jobs:
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run quality checks
        run: |
          uv run ruff format --check src tests
          uv run ruff check src tests
          uv run mypy --namespace-packages -p src
          uv run bandit -r src -c pyproject.toml

  test:
    name: Test ${{ matrix.group }}
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        group:
          - agent
          - cache-embeddings
          - evaluation-guardrails
          - ingestion-retrieval
          - observability
          - experimentation
          - performance-cost
    services:
      qdrant:
        image: qdrant/qdrant:latest
        ports:
          - 6333:6333
          - 6334:6334
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Wait for services
        run: |
          echo "Waiting for Qdrant..."
          for i in {1..30}; do
            curl -f http://localhost:6333/healthz > /dev/null 2>&1 && break
            sleep 2
          done
          echo "Waiting for Redis..."
          for i in {1..30}; do
            nc -zv localhost 6379 2>&1 | grep -q 'succeeded' && break
            sleep 2
          done

      - name: Run tests - ${{ matrix.group }}
        run: |
          case "${{ matrix.group }}" in
            agent)
              uv run pytest tests/unit/services/agent -v -k "not slow" -p no:cacheprovider --tb=short
              ;;
            cache-embeddings)
              uv run pytest tests/unit/services/cache tests/unit/services/embeddings -v -k "not slow" -p no:cacheprovider --tb=short
              ;;
            evaluation-guardrails)
              uv run pytest tests/unit/services/evaluation tests/unit/services/guardrails -v -k "not slow" -p no:cacheprovider --tb=short
              ;;
            ingestion-retrieval)
              uv run pytest tests/unit/services/ingestion tests/unit/services/retrieval -v -k "not slow" -p no:cacheprovider --tb=short
              ;;
            observability)
              uv run pytest tests/unit/services/observability -v -k "not slow" -p no:cacheprovider --tb=short
              ;;
            experimentation)
              uv run pytest tests/unit/services/experimentation -v -k "not slow" -p no:cacheprovider --tb=short
              ;;
            performance-cost)
              uv run pytest tests/unit/services/performance tests/unit/services/cost -v -k "not slow" -p no:cacheprovider --tb=short
              ;;
          esac
        env:
          REDIS__HOST: localhost
          REDIS__PORT: 6379
          QDRANT__URL: http://localhost:6333

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: lint
    services:
      qdrant:
        image: qdrant/qdrant:latest
        ports:
          - 6333:6333
          - 6334:6334
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Wait for services
        run: |
          echo "Waiting for Qdrant..."
          for i in {1..30}; do
            curl -f http://localhost:6333/healthz > /dev/null 2>&1 && break
            sleep 2
          done

      - name: Run integration tests
        run: |
          uv run pytest tests/integration -v -k "not slow" -p no:cacheprovider --tb=short \
            --ignore=tests/integration/test_sandbox_integration.py || true
        env:
          REDIS__HOST: localhost
          REDIS__PORT: 6379
          QDRANT__URL: http://localhost:6333
