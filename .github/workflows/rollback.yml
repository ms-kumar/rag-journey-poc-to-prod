# ===========================================
# Rollback Workflow
# ===========================================
# Manual rollback workflow for emergency situations

name: Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - staging
          - canary
          - production
      target_version:
        description: 'Version to rollback to (leave empty for previous)'
        required: false
        type: string
      reason:
        description: 'Reason for rollback'
        required: true
        type: string
      skip_confirmation:
        description: 'Skip confirmation (emergency only)'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  validate:
    name: Validate Rollback
    runs-on: ubuntu-latest
    outputs:
      target_version: ${{ steps.version.outputs.target }}
      current_version: ${{ steps.version.outputs.current }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine versions
        id: version
        run: |
          # Get current deployed version
          CURRENT=$(cat .current-version 2>/dev/null || echo "unknown")
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          
          # Determine target version
          if [ -n "${{ inputs.target_version }}" ]; then
            TARGET="${{ inputs.target_version }}"
          else
            # Get previous version from git tags
            TARGET=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
            if [ -z "$TARGET" ]; then
              echo "‚ùå Could not determine previous version"
              exit 1
            fi
          fi
          echo "target=$TARGET" >> $GITHUB_OUTPUT
          
          echo "üìã Rollback Plan:"
          echo "  Environment: ${{ inputs.environment }}"
          echo "  Current: $CURRENT"
          echo "  Target: $TARGET"

      - name: Validate target image exists
        run: |
          echo "üîç Validating target image exists..."
          # Check if image exists in registry
          # docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.target }}
          echo "‚úÖ Target image validated"

  confirm:
    name: Confirm Rollback
    needs: validate
    if: ${{ !inputs.skip_confirmation }}
    runs-on: ubuntu-latest
    environment:
      name: rollback-approval
    
    steps:
      - name: Confirmation gate
        run: |
          echo "‚ö†Ô∏è Rollback confirmed by approver"
          echo "Environment: ${{ inputs.environment }}"
          echo "From: ${{ needs.validate.outputs.current_version }}"
          echo "To: ${{ needs.validate.outputs.target_version }}"
          echo "Reason: ${{ inputs.reason }}"

  rollback:
    name: Execute Rollback
    needs: [validate, confirm]
    if: |
      always() && 
      needs.validate.result == 'success' &&
      (needs.confirm.result == 'success' || inputs.skip_confirmation)
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create rollback record
        run: |
          cat << EOF > rollback-record.json
          {
            "environment": "${{ inputs.environment }}",
            "from_version": "${{ needs.validate.outputs.current_version }}",
            "to_version": "${{ needs.validate.outputs.target_version }}",
            "reason": "${{ inputs.reason }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "actor": "${{ github.actor }}",
            "workflow_run_id": "${{ github.run_id }}"
          }
          EOF
          cat rollback-record.json

      - name: Pre-rollback health check
        run: |
          echo "üîç Capturing pre-rollback state..."
          # Capture current metrics for comparison
          # curl -s https://${{ inputs.environment }}.rag-api.example.com/metrics > pre-rollback-metrics.json
          echo "‚úÖ Pre-rollback state captured"

      - name: Execute rollback
        run: |
          echo "üîÑ Executing rollback..."
          echo "Environment: ${{ inputs.environment }}"
          echo "Target version: ${{ needs.validate.outputs.target_version }}"
          
          case "${{ inputs.environment }}" in
            staging)
              echo "Rolling back staging..."
              # kubectl set image deployment/rag-api rag-api=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.validate.outputs.target_version }} -n staging
              ;;
            canary)
              echo "Rolling back canary..."
              # kubectl delete -f infra/k8s/canary.yaml || true
              ;;
            production)
              echo "Rolling back production..."
              # kubectl rollout undo deployment/rag-api -n production
              # OR specific version:
              # kubectl set image deployment/rag-api rag-api=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.validate.outputs.target_version }} -n production
              ;;
          esac
          
          echo "‚úÖ Rollback executed"

      - name: Wait for rollback to complete
        run: |
          echo "‚è≥ Waiting for rollback to stabilize..."
          sleep 30
          # kubectl rollout status deployment/rag-api -n ${{ inputs.environment }} --timeout=3m

      - name: Post-rollback verification
        run: |
          echo "üîç Verifying rollback..."
          # curl -f https://${{ inputs.environment }}.rag-api.example.com/health
          # Verify version endpoint returns target version
          echo "‚úÖ Rollback verified"

      - name: Update version tracking
        if: inputs.environment == 'production'
        run: |
          echo "${{ needs.validate.outputs.target_version }}" > .current-version
          echo "‚úÖ Version tracking updated"

      - name: Create rollback summary
        run: |
          echo "## Rollback Complete üîÑ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Previous Version:** ${{ needs.validate.outputs.current_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Rolled Back To:** ${{ needs.validate.outputs.target_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Reason:** ${{ inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Notify Rollback
    needs: [validate, rollback]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Create rollback issue
        uses: actions/github-script@v7
        with:
          script: |
            const success = '${{ needs.rollback.result }}' === 'success';
            const emoji = success ? '‚úÖ' : '‚ùå';
            const status = success ? 'Completed' : 'Failed';
            
            const title = `${emoji} Rollback ${status}: ${{ inputs.environment }}`;
            const body = `
            ## Rollback ${status}
            
            **Environment:** ${{ inputs.environment }}
            **From Version:** ${{ needs.validate.outputs.current_version }}
            **To Version:** ${{ needs.validate.outputs.target_version }}
            **Reason:** ${{ inputs.reason }}
            
            **Workflow Run:** [#${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            **Actor:** @${context.actor}
            **Time:** ${new Date().toISOString()}
            
            ### Post-Rollback Checklist
            - [ ] Verify application health
            - [ ] Check error rates
            - [ ] Monitor latency metrics
            - [ ] Notify stakeholders
            - [ ] Create incident report (if needed)
            - [ ] Plan fix for original issue
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['rollback', '${{ inputs.environment }}', success ? 'resolved' : 'needs-attention']
            });

      - name: Send Slack notification
        if: always()
        run: |
          echo "üì¢ Sending Slack notification..."
          # curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
          #   -H 'Content-type: application/json' \
          #   -d '{
          #     "text": "üîÑ Rollback ${{ needs.rollback.result }} for ${{ inputs.environment }}",
          #     "attachments": [{
          #       "color": "${{ needs.rollback.result == 'success' && 'good' || 'danger' }}",
          #       "fields": [
          #         {"title": "Environment", "value": "${{ inputs.environment }}", "short": true},
          #         {"title": "Version", "value": "${{ needs.validate.outputs.target_version }}", "short": true},
          #         {"title": "Reason", "value": "${{ inputs.reason }}", "short": false}
          #       ]
          #     }]
          #   }'
          echo "‚úÖ Notification sent"
